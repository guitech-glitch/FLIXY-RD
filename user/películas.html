<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Administraci√≥n de Pel√≠culas (GitHub Write Enabled)</title>
<style>
  /* Variables de Color (Modern Dark Theme) */
  :root {
    --bg-color: #1a1a2e;
    --card-bg: #2c2c54;
    --primary-color: #00bcd4;
    --text-light: #e0e0e0;
    --text-muted: #99a2ad;
    --border-color: #3e445f;
    --shadow-color: rgba(0, 0, 0, 0.4);
    --input-bg: #3e445f; /* Fondo del input de b√∫squeda */
    --delete-color: #dc3545; /* Color para el bot√≥n Eliminar (rojo) */
    --success-color: #28a745; /* Color para el bot√≥n Guardar/√âxito */
  }

  /* Estilos generales */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-light);
    margin: 0;
    padding: 0;
    line-height: 1.6;
  }
  
  /* Botones (Estilo Moderno) */
  button, .card-info a {
    background-color: var(--primary-color);
    color: var(--bg-color); 
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.1s ease;
    text-decoration: none; 
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    text-align: center;
    white-space: nowrap;
  }
  button:hover, .card-info a:hover {
    background-color: #0097a7; 
    transform: translateY(-1px); 
    box-shadow: 0 4px 8px var(--shadow-color);
  }
  /* Deshabilitar bot√≥n */
  button:disabled {
      background-color: var(--border-color);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
  }
  
  #repoList button, .card-actions button {
    background-color: var(--border-color);
    color: var(--text-light);
  }
  #repoList button.active { 
    background-color: var(--primary-color);
    color: var(--bg-color);
  }
  #repoList button:hover, .card-actions button:hover {
    background-color: #555b7c;
  }

  /* Estilo espec√≠fico para el bot√≥n de Eliminar */
  .card-actions .delete-button {
    background-color: var(--delete-color); /* Rojo */
    color: white;
  }
  .card-actions .delete-button:hover {
    background-color: #c82333; /* Rojo m√°s oscuro al pasar el rat√≥n */
  }
  
  /* Estilo espec√≠fico para el bot√≥n de Guardar en el modal */
  #modalGuardarBtn, #addMovieBtn {
    background-color: var(--success-color); 
    color: white;
  }
  #modalGuardarBtn:hover, #addMovieBtn:hover {
    background-color: #218838;
  }

  /* NUEVO ESTILO: Bot√≥n Cancelar */
  #modalCancelBtn, #addModalCancelBtn {
    background-color: var(--border-color); /* Color neutro/oscuro */
    color: var(--text-light);
  }
  #modalCancelBtn:hover, #addModalCancelBtn:hover {
    background-color: #555b7c;
  }
  
  /* 1. Barra superior (App Bar) */
  .top-menu {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: var(--card-bg); 
    padding: 15px 30px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 4px 8px var(--shadow-color);
  }
  .top-menu h1 {
    margin: 0;
    font-size: 24px;
    letter-spacing: 1px;
    font-weight: 300;
  }
  .top-menu .menu-buttons {
      display: flex; /* Asegura que los botones est√°n en fila */
      gap: 15px; /* Espacio entre los botones */
  }
  .top-menu .menu-buttons button .icon {
      margin-right: 5px;
  }
  
  /* 2. Buscador y Sugerencias */
  #searchContainer {
      position: relative; /* Contenedor para posicionar las sugerencias */
      padding: 20px 30px 0; /* Espacio antes del buscador y al lado */
      background-color: var(--bg-color);
      z-index: 90; /* Debajo del top-menu */
  }
  #searchBox {
      width: 100%;
      padding: 15px 20px;
      font-size: 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--input-bg);
      color: var(--text-light);
      box-sizing: border-box; 
      transition: border-color 0.2s;
  }
  #searchBox:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 5px var(--primary-color);
  }

  /* Contenedor de sugerencias */
  #suggestionsList {
      position: absolute;
      top: 100%; /* Justo debajo del input */
      left: 30px;
      right: 30px;
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 110; /* Encima de todo el contenido */
      box-shadow: 0 8px 16px var(--shadow-color);
      display: none; /* Ocultar por defecto */
  }
  .suggestion-item {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .suggestion-item:last-child {
      border-bottom: none;
  }
  .suggestion-item:hover {
      background-color: #4a507a;
  }
  .suggestion-item .repo-tag {
      font-size: 11px;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      padding: 2px 5px;
      border-radius: 4px;
  }

  /* 3. Contenedor de Repositorios (Chips/Tags) */
  #repoList {
    margin: 15px 30px;
    display: none; /* Ocultar por defecto, se muestra con el bot√≥n */
    flex-wrap: wrap;
    gap: 8px; 
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color); 
  }
  #repoList button {
    padding: 6px 12px;
    border-radius: 20px; 
    font-size: 13px;
    font-weight: 500;
    background-color: var(--border-color); 
    color: var(--text-light);
  }
  
  /* 4. Contenedor de Cards */
  .card-container {
    /* CAMBIO: De flex a grid para las columnas */
    display: grid;
    grid-template-columns: 1fr; /* Por defecto (m√≥vil), 1 columna */
    gap: 15px;
    margin-top: 20px;
    padding: 0 30px 40px; 
  }
  .card {
    display: flex;
    background-color: var(--card-bg);
    border-radius: 10px; 
    padding: 15px;
    align-items: flex-start;
    box-shadow: 0 4px 12px var(--shadow-color); 
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px var(--shadow-color);
  }
  .card img {
    width: 80px; 
    height: 120px;
    object-fit: cover; 
    border-radius: 4px;
    margin-right: 15px;
    box-shadow: 0 2px 5px var(--shadow-color);
    flex-shrink: 0; 
  }
  .card-info {
    display: flex;
    flex-direction: column;
    flex-grow: 1; 
    gap: 5px;
    justify-content: space-between; 
    min-height: 120px;
  }
  .card-info strong {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-light);
  }
  .card-details {
      display: flex;
      flex-direction: column;
      gap: 3px;
      margin-bottom: 5px;
  }
  .card-details span {
    font-size: 13px;
    color: var(--text-muted);
    font-style: italic;
    line-height: 1.2;
  }
  .card-actions {
    display: flex;
    gap: 8px; 
    margin-top: 5px;
    margin-left: auto;
    flex-shrink: 0;
  }
  .card-placeholder {
    width: 80px;
    height: 120px;
    background-color: var(--border-color);
    border-radius: 4px;
    margin-right: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    text-align: center;
    color: var(--text-muted);
    flex-shrink: 0;
  }
  
  /* ================================== */
  /* NUEVO: 5. Estilos de Paginaci√≥n    */
  /* ================================== */
  .pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
    /* Se elimina el padding superior para que est√© m√°s pegado a las cards */
    padding: 0 30px 40px; 
    gap: 8px;
    flex-wrap: wrap; /* Para que se ajuste en m√≥viles */
  }
  .pagination-container button {
    background-color: var(--border-color);
    color: var(--text-light);
    padding: 8px 12px;
    font-size: 14px;
    min-width: 40px;
    border-radius: 6px;
  }
  .pagination-container button:hover {
    background-color: #555b7c;
  }
  .pagination-container button.active {
    background-color: var(--primary-color);
    color: var(--bg-color);
    font-weight: bold;
  }
  .pagination-container button:disabled {
    background-color: var(--bg-color); /* Fondo m√°s oscuro */
    color: var(--text-muted);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  .pagination-container span {
      color: var(--text-muted);
      padding: 0 5px;
      font-size: 14px;
      font-weight: bold;
  }

  /* 6. Estilos del Modal de Edici√≥n (Desktop/Tablet) */
  .modal {
    position: fixed;
    z-index: 200; 
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.7); /* Oscurecer el fondo */
    display: none; /* Oculto por defecto */
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background-color: var(--card-bg);
    padding: 30px;
    border-radius: 10px;
    width: 90%; 
    max-width: 500px; /* Ancho m√°ximo para desktop */
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    animation-name: animatetop;
    animation-duration: 0.4s;
    max-height: 90vh; 
    overflow-y: auto; 
  }

  @keyframes animatetop {
    from {top:-300px; opacity:0} 
    to {top:0; opacity:1}
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 15px;
    margin-bottom: 20px;
  }

  .modal-header h2 {
    margin: 0;
    font-size: 20px;
    color: var(--primary-color);
  }
  
  .modal-body-info {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      align-items: flex-start;
  }
  
  #modalPoster {
    width: 100px;
    height: 150px;
    object-fit: cover;
    border-radius: 6px;
    flex-shrink: 0;
    box-shadow: 0 2px 5px var(--shadow-color);
  }
  
  .modal-text-details {
      display: flex;
      flex-direction: column;
      gap: 5px;
  }
  .modal-text-details strong {
      font-size: 18px;
  }
  .modal-text-details span {
      font-size: 14px;
      color: var(--text-muted);
  }

  .modal-input-group {
    margin-bottom: 15px;
  }
  
  .modal-input-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      font-weight: 600;
  }

  /* Estilos para inputs y selects en modales */
  #modalVideoLink, #addTmdbId, #addVideoLink, #addRepoSelect {
    width: 100%;
    padding: 10px;
    font-size: 14px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: var(--input-bg);
    color: var(--text-light);
    box-sizing: border-box; 
    transition: border-color 0.2s;
  }
  
  #modalVideoLink:focus, #addTmdbId:focus, #addVideoLink:focus, #addRepoSelect:focus {
      border-color: var(--primary-color);
      outline: none;
  }
  /* Ajuste para input de tipo n√∫mero (ocultar flechas en Firefox) */
  #addTmdbId {
      -moz-appearance: textfield;
  }
  /* Ocultar flechas en Chrome, Safari, Edge */
  #addTmdbId::-webkit-outer-spin-button,
  #addTmdbId::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
  }


  .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
  }

  /* --- INICIO: ESTILOS DEL DI√ÅLOGO PERSONALIZADO (ALERT/CONFIRM) --- */
  #customDialog {
    /* Reutiliza el estilo base del modal para el fondo */
    display: none; /* Oculto por defecto */
  }

  .custom-dialog-content {
    background-color: var(--card-bg);
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
    animation-name: animatetop; /* Reutilizamos la animaci√≥n */
    animation-duration: 0.3s;
    border-left: 5px solid var(--primary-color); /* Toque visual */
  }

  #dialogMessage {
    margin-bottom: 20px;
    font-size: 15px;
    line-height: 1.5;
    color: var(--text-light);
    white-space: pre-wrap; /* Respeta los saltos de l√≠nea (\n) */
  }

  .dialog-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  /* Estilo para los botones dentro del di√°logo */
  .dialog-actions button {
      padding: 8px 15px;
      font-size: 13px;
  }

  /* Bot√≥n principal (Aceptar/S√≠) - Por defecto, color de eliminaci√≥n */
  #dialogPrimaryBtn {
    background-color: var(--delete-color); 
    color: white;
  }
  #dialogPrimaryBtn:hover {
    background-color: #c82333;
  }

  /* Bot√≥n secundario (Cancelar/No) */
  #dialogSecondaryBtn {
    background-color: var(--border-color);
    color: var(--text-light);
  }
  #dialogSecondaryBtn:hover {
    background-color: #555b7c;
  }

  /* Estilo para ALERTAS (Mensajes de √©xito o error) */
  .custom-dialog-content.alert-success {
      border-left-color: var(--success-color); /* Borde verde para √©xito */
  }
  .custom-dialog-content.alert-error {
      border-left-color: var(--delete-color); /* Borde rojo para error */
  }
  /* --- FIN: ESTILOS DEL DI√ÅLOGO PERSONALIZADO --- */
  
  /* ================================================= */
  /* RESPONSIVIDAD (Media Query - Ajustes M√≥viles)     */
  /* ================================================= */
  @media (max-width: 600px) { 
    
    /* 1. Encabezado (Top Menu) */
    .top-menu {
      padding: 12px 15px; 
      flex-direction: column; 
      align-items: flex-start;
      gap: 10px;
    }
    .top-menu h1 {
      font-size: 18px;
    }
    .top-menu .menu-buttons {
        width: 100%; 
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap; 
        gap: 8px; 
    }
    .top-menu .menu-buttons button .icon { margin-right: 0;}
    .top-menu .menu-buttons button {
      margin-left: 0;
      flex-grow: 1; 
      margin-right: 0; 
      padding: 8px 0; 
      font-size: 0; 
    }
    .top-menu .menu-buttons button:nth-child(1) { flex-basis: calc(50% - 4px); }
    .top-menu .menu-buttons button:nth-child(2) { flex-basis: calc(50% - 4px); }
    .top-menu .menu-buttons button:nth-child(3) { flex-basis: calc(50% - 4px); }
    
    .top-menu .menu-buttons button:nth-child(1)::before { 
        content: "üìÅ Repos"; 
        font-size: 13px;
    }
    #seriesBtn::before { 
        content: "üì∫ Pel√≠culas";
        font-size: 13px;
    }
    .top-menu .menu-buttons button:nth-child(3)::before {
        content: "‚ûï Agregar";
        font-size: 13px;
    }
    
    /* 2. Buscador */
    #searchContainer {
        padding: 15px 15px 0;
    }
    #suggestionsList {
        left: 15px;
        right: 15px;
    }
    
    /* 3. Repositorios (Chips) */
    #repoList {
      margin: 10px 15px;
    }
    #repoList button {
        font-size: 11px;
        padding: 4px 8px;
    }

    /* 4. Cards */
    .card-container {
      padding: 0 15px 30px; 
      gap: 12px;
      /* En m√≥vil, ya estaba a 1 columna (grid-template-columns: 1fr;) */
    }
    .card {
        padding: 10px;
        align-items: stretch;
    }
    
    .card img, .card-placeholder {
      width: 60px; 
      height: 90px;
      margin-right: 10px;
    }
    
    /* 5. Informaci√≥n y Acciones */
    .card-info {
        min-height: 90px;
        justify-content: space-between;
    }
    .card-info strong {
        font-size: 14px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
    }
    .card-details span {
        font-size: 11px;
    }
    .card-actions {
        flex-direction: row;
        width: 100%; 
        margin-left: 0;
        justify-content: flex-start;
        gap: 5px; 
        margin-top: 8px;
        flex-wrap: wrap; 
    }
    .card-actions a, .card-actions button {
        flex-basis: calc(50% - 5px); 
        padding: 8px 2px;
        font-size: 10px;
    }
    .card-actions .delete-button { 
        flex-basis: calc(50% - 5px);
    }
    
    /* 6. MODAL RESPONSIVE EN M√ìVILES (Ajustes de la petici√≥n) */
    .modal-content {
        /* Permite que el modal ocupe m√°s espacio en pantallas peque√±as */
        width: 95%; 
        max-width: none; /* Ignorar el max-width de 500px en m√≥vil */
        margin: 5vh auto; /* Deja un peque√±o margen arriba y abajo */
    }
    
    /* Apila la imagen y los detalles para mejor visualizaci√≥n */
    .modal-body-info {
        flex-direction: column;
        align-items: center; /* Centra la car√°tula */
        text-align: center;
    }
    
    #modalPoster, #addTmdbResultContainer img {
        width: 80px;
        height: 120px;
        margin-bottom: 10px; /* Separaci√≥n despu√©s de la car√°tula */
    }

    /* Hace que los botones de acci√≥n del modal sean de ancho completo si es necesario */
    .modal-actions {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    .modal-actions button {
        flex-basis: calc(50% - 5px); /* Divide el espacio casi a la mitad */
        padding: 10px 0;
    }
    /* Espec√≠fico para el modal de agregar */
    #addTmdbSearchBtn {
        padding: 10px 15px !important;
    }


    /* Ajuste para el di√°logo personalizado en m√≥vil */
    .dialog-actions {
        flex-wrap: wrap;
    }
    .dialog-actions button {
         flex-basis: calc(50% - 5px);
         padding: 8px 0;
    }
  }

  /* ================================================= */
  /* NUEVO: Media Query para 2 Columnas en Desktop     */
  /* ================================================= */
  @media (min-width: 992px) { /* A partir de 992px de ancho */
    .card-container {
      grid-template-columns: 1fr 1fr; /* 2 columnas de igual tama√±o */
      gap: 20px; /* Un poco m√°s de espacio en desktop */
    }
  }

</style>
</head>
<body>

<div class="top-menu">
  <h1> FLIXY PANNEL</h1>
  <div class="menu-buttons">
    <button id="showReposBtn">
        <span class="icon">üìÅ</span> Repositorios
    </button>
    <button id="seriesBtn">
        <span class="icon">üì∫</span> Series
    </button>
    <button id="addBtn">
        <span class="icon">‚ûï</span> Agregar Pel√≠cula
    </button>
  </div>
</div>

<div id="searchContainer">
    <input type="text" id="searchBox" placeholder="Buscar por T√≠tulo, ID de TMDB o Repositorio..." autocomplete="off">
    <div id="suggestionsList"></div>
</div>

<div id="repoList"></div>

<div id="m3uCards" class="card-container"></div>

<div id="paginationContainer" class="pagination-container"></div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Editar Enlace de V√≠deo</h2>
      </div>
    <div class="modal-body">
      
      <div class="modal-body-info">
        <img id="modalPoster" src="" alt="Car√°tula" />
        <div class="modal-text-details">
            <strong id="modalTitle"></strong>
            <span id="modalYear"></span>
            <span id="modalRepo"></span>
        </div>
      </div>

      <div class="modal-input-group">
        <label for="modalVideoLink">Nuevo Enlace de V√≠deo (M3U):</label>
        <input type="url" id="modalVideoLink" placeholder="https://nuevo-enlace.m3u8" required>
        <input type="hidden" id="modalOldVideoLink">
        <input type="hidden" id="modalOldDownloadLink">
        <input type="hidden" id="modalExtinfLine">
        <input type="hidden" id="modalTvgLogoLine"> <input type="hidden" id="modalM3UFileName">
        <input type="hidden" id="modalRepoName">
      </div>
      
    </div>
    <div class="modal-actions">
      <button id="modalCancelBtn" onclick="document.getElementById('editModal').style.display='none'">Cancelar</button>
      <button id="modalGuardarBtn" onclick="actualizarEnlaceVideo()">Guardar</button>
    </div>
  </div>
</div>

<div id="addMovieModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Agregar Nueva Pel√≠cula</h2>
    </div>
    <div class="modal-body">
      
        <div class="modal-input-group">
            <label for="addTmdbId">ID de TMDB:</label>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="addTmdbId" placeholder="Ej: 603" style="flex-grow: 1;">
                <button id="addTmdbSearchBtn" onclick="searchTmdb()" style="flex-shrink: 0; background-color: var(--primary-color); color: white;">Buscar</button>
            </div>
        </div>
        
        <div id="addTmdbResultContainer" style="display: none; margin-top: 20px;">
            </div>
        
        <div id="addMovieInputs" style="display: none; margin-top: 20px;">
            <div class="modal-input-group">
                <label for="addVideoLink">Enlace de V√≠deo (M3U):</label>
                <input type="url" id="addVideoLink" placeholder="https://filemoon.sx/e/..." required>
            </div>
            <div class="modal-input-group">
                <label for="addRepoSelect">Repositorio de Destino:</label>
                <select id="addRepoSelect">
                    </select>
            </div>
            
            <div class="modal-input-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <input type="checkbox" id="addAtEndCheckbox" style="width: 18px; height: 18px; flex-shrink: 0;">
                <label for="addAtEndCheckbox" style="margin-bottom: 0; font-weight: 500;">Colocar al final de la lista (por defecto se agrega al inicio)</label>
            </div>
            </div>
      
    </div>
    <div class="modal-actions" style="border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 0;">
      <button id="addModalCancelBtn" onclick="document.getElementById('addMovieModal').style.display='none'">Cancelar</button>
      <button id="addMovieBtn" onclick="commitNewMovie()" style="display: none;">Agregar Pel√≠cula</button>
    </div>
  </div>
</div>
<div id="customDialog" class="modal">
  <div id="customDialogContent" class="custom-dialog-content">
    <p id="dialogMessage"></p>
    <div class="dialog-actions">
      <button id="dialogSecondaryBtn">Cancelar</button>
      <button id="dialogPrimaryBtn">Aceptar</button>
    </div>
  </div>
</div>
<script>
// NOTA IMPORTANTE: Debes reemplazar estos valores con los tuyos para que el script funcione correctamente.
const username = "jhonielproyectos002-glitch";  
const token = "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"; 
const TMDB_API_KEY = "60d9b5cc5a23b1b97a2a7cb34a5e4373"; 

let allM3UData = []; 
let allMovieItems = []; 
let currentFilterRepo = "Todos"; 
let repositorios = []; 
let currentTmdbData = null; 

let currentPage = 1;
const itemsPerPage = 20;
let currentFilteredItems = []; 

// Elementos del DOM
const repoListDiv = document.getElementById("repoList");
const searchBox = document.getElementById("searchBox");
const suggestionsList = document.getElementById("suggestionsList");
const editModal = document.getElementById("editModal");
const addMovieModal = document.getElementById("addMovieModal");


// --- L√ìGICA DE DI√ÅLOGO PERSONALIZADO ---

function showCustomDialog(message, isConfirmation, primaryText = 'Aceptar', secondaryText = 'Cancelar', dialogType = '') {
    return new Promise(resolve => {
        const dialog = document.getElementById('customDialog');
        const content = document.getElementById('customDialogContent');
        const msgElement = document.getElementById('dialogMessage');
        const primaryBtn = document.getElementById('dialogPrimaryBtn');
        const secondaryBtn = document.getElementById('dialogSecondaryBtn');
        
        msgElement.textContent = message;
        primaryBtn.textContent = primaryText;
        content.className = `custom-dialog-content ${dialogType}`; 
        
        if (isConfirmation) {
            secondaryBtn.textContent = secondaryText;
            secondaryBtn.style.display = 'inline-block';
            if (primaryText.toLowerCase().includes('eliminar')) {
                primaryBtn.style.backgroundColor = 'var(--delete-color)';
                primaryBtn.onmouseover = () => primaryBtn.style.backgroundColor = '#c82333';
                primaryBtn.onmouseout = () => primaryBtn.style.backgroundColor = 'var(--delete-color)';
            } else {
                primaryBtn.style.backgroundColor = 'var(--success-color)';
                primaryBtn.onmouseover = () => primaryBtn.style.backgroundColor = '#218838';
                primaryBtn.onmouseout = () => primaryBtn.style.backgroundColor = 'var(--success-color)';
            }
        } else {
            secondaryBtn.style.display = 'none';
            if(dialogType === 'alert-success') {
                 primaryBtn.style.backgroundColor = 'var(--success-color)';
                 primaryBtn.onmouseover = () => primaryBtn.style.backgroundColor = '#218838';
                 primaryBtn.onmouseout = () => primaryBtn.style.backgroundColor = 'var(--success-color)';
            } else if (dialogType === 'alert-error') {
                 primaryBtn.style.backgroundColor = 'var(--delete-color)';
                 primaryBtn.onmouseover = () => primaryBtn.style.backgroundColor = '#c82333';
                 primaryBtn.onmouseout = () => primaryBtn.style.backgroundColor = 'var(--delete-color)';
            } else {
                 primaryBtn.style.backgroundColor = 'var(--primary-color)';
                 primaryBtn.onmouseover = () => primaryBtn.style.backgroundColor = '#0097a7';
                 primaryBtn.onmouseout = () => primaryBtn.style.backgroundColor = 'var(--primary-color)';
            }
        }

        dialog.style.display = 'flex';

        const primaryHandler = () => {
            dialog.style.display = 'none';
            resolve(true);
            primaryBtn.removeEventListener('click', primaryHandler);
            secondaryBtn.removeEventListener('click', secondaryHandler);
            document.removeEventListener('keydown', escHandler);
        };

        const secondaryHandler = () => {
            dialog.style.display = 'none';
            resolve(false);
            primaryBtn.removeEventListener('click', primaryHandler);
            secondaryBtn.removeEventListener('click', secondaryHandler);
            document.removeEventListener('keydown', escHandler);
        };
        
        primaryBtn.addEventListener('click', primaryHandler);
        secondaryBtn.addEventListener('click', secondaryHandler);
        
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                document.removeEventListener('keydown', escHandler);
                primaryBtn.removeEventListener('click', primaryHandler);
                secondaryBtn.removeEventListener('click', secondaryHandler);
                const result = isConfirmation ? false : true;
                dialog.style.display = 'none';
                resolve(result);
            }
        };
        document.addEventListener('keydown', escHandler);
    });
}

// --- EVENT LISTENERS ---
document.getElementById("showReposBtn").addEventListener("click", mostrarRepositorios);

document.getElementById("seriesBtn").addEventListener("click", () => {
    showCustomDialog('Funcionalidad de Series no implementada', false, 'Entendido');
});

document.getElementById("addBtn").addEventListener("click", openAddMovieModal);

searchBox.addEventListener("input", handleSearchInput); 
document.addEventListener("click", (e) => {
    const searchContainer = document.getElementById("searchContainer");
    if (!searchContainer.contains(e.target)) {
        suggestionsList.style.display = 'none';
    }
});

window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        editModal.style.display = 'none';
        addMovieModal.style.display = 'none'; 
    }
});

function renderPage() {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    if (!Array.isArray(currentFilteredItems)) currentFilteredItems = [];
    const pageItems = currentFilteredItems.slice(startIndex, endIndex);
    mostrarCards(pageItems); 
    renderPagination();
}

function renderPagination() {
    const container = document.getElementById("paginationContainer");
    container.innerHTML = "";
    const totalItems = currentFilteredItems.length;
    if (totalItems <= itemsPerPage) return;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    
    const prevBtn = document.createElement("button");
    prevBtn.textContent = "¬´ Ant";
    prevBtn.disabled = (currentPage === 1);
    prevBtn.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            renderPage();
            window.scrollTo(0, 0);
        }
    };
    container.appendChild(prevBtn);

    const maxPagesToShow = 5; 
    let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

    if (endPage === totalPages) startPage = Math.max(1, endPage - maxPagesToShow + 1);
    if (startPage === 1) endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

    if (startPage > 1) {
        const firstBtn = document.createElement("button");
        firstBtn.textContent = "1";
        firstBtn.onclick = () => {
            currentPage = 1; renderPage(); window.scrollTo(0, 0);
        };
        container.appendChild(firstBtn);
        if (startPage > 2) {
            const ellipsis = document.createElement("span");
            ellipsis.textContent = "...";
            container.appendChild(ellipsis);
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement("button");
        pageBtn.textContent = i;
        if (i === currentPage) pageBtn.classList.add("active");
        pageBtn.onclick = () => {
            currentPage = i; renderPage(); window.scrollTo(0, 0);
        };
        container.appendChild(pageBtn);
    }
    
    if (endPage < totalPages) {
         if (endPage < totalPages - 1) {
            const ellipsis = document.createElement("span");
            ellipsis.textContent = "...";
            container.appendChild(ellipsis);
        }
        const lastBtn = document.createElement("button");
        lastBtn.textContent = totalPages;
        lastBtn.onclick = () => {
            currentPage = totalPages; renderPage(); window.scrollTo(0, 0);
        };
        container.appendChild(lastBtn);
    }

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "Sig ¬ª";
    nextBtn.disabled = (currentPage === totalPages);
    nextBtn.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++; renderPage(); window.scrollTo(0, 0);
        }
    };
    container.appendChild(nextBtn);
}

function handleSearchInput() {
    const query = searchBox.value.toLowerCase().trim();
    suggestionsList.innerHTML = '';
    
    if (query.length < 1) {
        suggestionsList.style.display = 'none';
        currentFilteredItems = filterByRepo(currentFilterRepo);
        currentPage = 1;
        renderPage();
        return;
    }
    
    let itemsToSearch = allMovieItems;
    if (currentFilterRepo !== "Todos") {
        itemsToSearch = allMovieItems.filter(item => item.repo === currentFilterRepo);
    }
    
    const filteredResults = itemsToSearch.filter(item => {
        const titleMatch = item.title.toLowerCase().includes(query);
        const tmdbIdMatch = item.tmdbId.includes(query);
        const repoMatch = item.repo.toLowerCase().includes(query);
        return titleMatch || tmdbIdMatch || repoMatch;
    });

    const suggestions = filteredResults.slice(0, 10);
    
    if (suggestions.length > 0) {
        suggestions.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.innerHTML = `<span>${item.title} (${item.year || 'N/A'})</span><span class="repo-tag">${item.repo}</span>`;
            div.onclick = () => {
                searchBox.value = item.title;
                suggestionsList.style.display = 'none';
                const finalItem = allMovieItems.filter(i => i.title === item.title && i.repo === item.repo);
                currentFilteredItems = finalItem;
                currentPage = 1;
                renderPage();
            };
            suggestionsList.appendChild(div);
        });
        suggestionsList.style.display = 'block';
    } else {
        suggestionsList.innerHTML = '<div class="suggestion-item" style="justify-content: center; color: var(--text-muted);">No se encontraron resultados</div>';
        suggestionsList.style.display = 'block';
    }
}

function mostrarRepositorios() {
  const isHidden = repoListDiv.style.display === 'none' || repoListDiv.style.display === '';
  repoListDiv.style.display = isHidden ? 'flex' : 'none';
  if (!isHidden) return;
  if (repoListDiv.children.length > 0) return;

  if (repositorios.length > 0) {
      const allBtn = document.createElement("button");
      allBtn.textContent = "Todos";
      allBtn.classList.add('active'); 
      allBtn.onclick = () => handleRepoClick("Todos", allBtn);
      repoListDiv.appendChild(allBtn);
  }

  repositorios.forEach(repo => {
    const btn = document.createElement("button");
    btn.textContent = repo.name;
    btn.onclick = () => handleRepoClick(repo.name, btn);
    repoListDiv.appendChild(btn);
  });
}

function handleRepoClick(repoName, clickedButton) {
    currentFilterRepo = repoName;
    searchBox.value = ''; 
    suggestionsList.style.display = 'none';
    document.querySelectorAll('#repoList button').forEach(btn => btn.classList.remove('active'));
    clickedButton.classList.add('active');
    currentFilteredItems = filterByRepo(repoName);
    currentPage = 1;
    renderPage();
}

function filterByRepo(repoName) {
    if (repoName === "Todos") return allMovieItems;
    return allMovieItems.filter(item => item.repo === repoName);
}

// ----------------------------------------------------------------------------------
// *** ELIMINAR (SOPORTA TVG-LOGO) ***
// ----------------------------------------------------------------------------------
async function eliminarPelicula(title, repo, tmdbId, m3uFileName, extinfLine, tvgLogoLine, videoLink, downloadLink) {
    const cleanTitle = title.replace(/\\'/g, "'");
    const msg = `¬øEst√°s seguro de que quieres **ELIMINAR** "${cleanTitle}"?`;
    
    if (!await showCustomDialog(msg, true, 'S√≠, Eliminar', 'Cancelar')) return;
    
    const container = document.getElementById("m3uCards");
    container.innerHTML = '<div style="text-align: center; padding: 50px; color: var(--primary-color);">Eliminando...</div>';

    try {
        const contentUrl = `https://api.github.com/repos/${username}/${repo}/contents/${m3uFileName}`;
        const contentRes = await fetch(contentUrl, { headers: { Authorization: `token ${token}` } });
        if (!contentRes.ok) throw new Error("Error API");
        const contentData = await contentRes.json();
        const currentContent = decodeURIComponent(escape(atob(contentData.content)));
        
        const lines = currentContent.split('\n');
        const indicesToRemove = [];
        
        const normExtinf = extinfLine.trim();
        const normLogo = tvgLogoLine ? tvgLogoLine.trim() : null;
        const normVideo = videoLink.trim();
        const normDown = downloadLink ? downloadLink.trim() : null;

        for (let i = 0; i < lines.length; i++) {
            if (lines[i].trim() === normExtinf) {
                indicesToRemove.push(i);
                let offset = 1;
                // Si existe logo y la siguiente l√≠nea coincide
                if (normLogo && lines[i + offset] && lines[i + offset].trim() === normLogo) {
                    indicesToRemove.push(i + offset);
                    offset++;
                }
                // Siguiente l√≠nea debe ser video
                if (lines[i + offset] && lines[i + offset].trim() === normVideo) {
                    indicesToRemove.push(i + offset);
                    offset++;
                }
                // Opcional descarga
                if (normDown && lines[i + offset] && lines[i + offset].trim() === normDown) {
                    indicesToRemove.push(i + offset);
                }
                break;
            }
        }
        
        let newContent = lines.filter((_, index) => !indicesToRemove.includes(index)).join('\n').trim() + '\n';
        const newContentBase64 = btoa(unescape(encodeURIComponent(newContent)));
        
        const updateRes = await fetch(contentUrl, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: `Eliminar: ${cleanTitle}`, content: newContentBase64, sha: contentData.sha })
        });

        if (updateRes.ok) {
            allMovieItems = allMovieItems.filter(item => !(item.extinfLine.trim() === extinfLine && item.repo === repo));
            currentFilteredItems = filterByRepo(currentFilterRepo);
            renderPage();
            await showCustomDialog(`¬°Eliminado!`, false, 'OK', null, 'alert-success');
        }
    } catch (error) {
        renderPage();
    }
}

// ----------------------------------------------------------------------------------
// *** EDICI√ìN (SOPORTA TVG-LOGO) ***
// ----------------------------------------------------------------------------------
function extraerIdDeVideo(link) {
    const trimmedLink = link.trim();
    const filemoonMatch = trimmedLink.match(/id=([a-zA-Z0-9]+)|(?:filemoon\.sx\/(?:e|d)\/)([a-zA-Z0-9]+)/);
    if (filemoonMatch) return filemoonMatch[1] || filemoonMatch[2];
    const fastreamMatch = trimmedLink.match(/\/embed-([a-zA-Z0-9]+)\.html/);
    if (fastreamMatch) return fastreamMatch[1];
    return null; 
}

async function abrirModalEdicion(item) {
    document.getElementById("modalTitle").textContent = item.title;
    document.getElementById("modalYear").textContent = `A√±o: ${item.year || 'N/A'}`;
    document.getElementById("modalRepo").textContent = `Repo: ${item.repo}`;
    document.getElementById("modalVideoLink").value = ""; 

    // PRIORIDAD: Si el item ya trae car√°tula del tvg-logo (item.logo), usar esa
    document.getElementById("modalPoster").src = item.logo || await fetchPoster(item.tmdbId) || "";

    document.getElementById("modalOldVideoLink").value = item.videoLink;
    document.getElementById("modalOldDownloadLink").value = item.downloadLink || "";
    document.getElementById("modalExtinfLine").value = item.extinfLine;
    document.getElementById("modalTvgLogoLine").value = item.tvgLogoLine || ""; // NUEVO
    document.getElementById("modalM3UFileName").value = item.m3uFileName;
    document.getElementById("modalRepoName").value = item.repo;
    
    editModal.style.display = "flex"; 
}

async function actualizarEnlaceVideo() {
    const newVideoLink = document.getElementById("modalVideoLink").value.trim();
    const oldVideoLink = document.getElementById("modalOldVideoLink").value.trim();
    const oldDownloadLink = document.getElementById("modalOldDownloadLink").value.trim();
    const extinfLine = document.getElementById("modalExtinfLine").value.trim();
    const tvgLogoLine = document.getElementById("modalTvgLogoLine").value.trim();
    const m3uFileName = document.getElementById("modalM3UFileName").value;
    const repoName = document.getElementById("modalRepoName").value;
    const movieTitle = document.getElementById("modalTitle").textContent;

    if (!newVideoLink) return;
    if (!await showCustomDialog(`¬øActualizar "${movieTitle}"?`, true, 'S√≠, Guardar', 'Cancelar')) return;
    
    const newVideoId = extraerIdDeVideo(newVideoLink);
    let newDownloadLink = newVideoId ? `https://corterlink.pages.dev/2?id=${newVideoId}` : "";
    
    const modalBody = document.querySelector('#editModal .modal-body');
    const modalActions = document.querySelector('#editModal .modal-actions');
    modalBody.innerHTML = '<div style="text-align: center; padding: 50px; color: var(--primary-color);">Actualizando...</div>';
    modalActions.style.display = 'none';

    try {
        const contentUrl = `https://api.github.com/repos/${username}/${repoName}/contents/${m3uFileName}`;
        const contentRes = await fetch(contentUrl, { headers: { Authorization: `token ${token}` } });
        const contentData = await contentRes.json();
        const currentContent = decodeURIComponent(escape(atob(contentData.content)));

        const escapeRegex = (str) => str.replace(/([.?*+^$[\]\\(){}|-])/g, "\\$1");
        
        // BLOQUE DE B√öSQUEDA DIN√ÅMICO
        let searchPattern = escapeRegex(extinfLine);
        if (tvgLogoLine) searchPattern += `\\s*\\n\\s*${escapeRegex(tvgLogoLine)}`;
        searchPattern += `\\s*\\n\\s*${escapeRegex(oldVideoLink)}`;
        if (oldDownloadLink) searchPattern += `\\s*\\n\\s*${escapeRegex(oldDownloadLink)}`;

        // BLOQUE DE REEMPLAZO DIN√ÅMICO
        let replacement = extinfLine;
        if (tvgLogoLine) replacement += `\n${tvgLogoLine}`;
        replacement += `\n${newVideoLink}`;
        if (newDownloadLink) replacement += `\n${newDownloadLink}`;

        const newContent = currentContent.replace(new RegExp(searchPattern, 'm'), replacement);
        const newContentBase64 = btoa(unescape(encodeURIComponent(newContent)));
        
        const updateRes = await fetch(contentUrl, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: `Update: ${movieTitle}`, content: newContentBase64, sha: contentData.sha })
        });

        if (updateRes.ok) {
            location.reload();
        }
    } catch (error) {
        location.reload();
    }
}

// ----------------------------------------------------------------------------------
// *** AGREGAR (SOPORTA TVG-LOGO) ***
// ----------------------------------------------------------------------------------
function openAddMovieModal() {
    const modal = document.getElementById('addMovieModal');
    document.getElementById('addTmdbId').value = '';
    document.getElementById('addVideoLink').value = '';
    document.getElementById('addAtEndCheckbox').checked = false;
    document.getElementById('addTmdbResultContainer').style.display = 'none';
    document.getElementById('addMovieInputs').style.display = 'none';
    document.getElementById('addMovieBtn').style.display = 'none';
    document.getElementById('addTmdbSearchBtn').disabled = false;
    currentTmdbData = null;
    const select = document.getElementById('addRepoSelect');
    select.innerHTML = '<option value="">Seleccionar repositorio...</option>';
    repositorios.forEach(repo => {
        const option = document.createElement('option');
        option.value = repo.name; option.textContent = repo.name;
        select.appendChild(option);
    });
    modal.style.display = 'flex';
}

async function searchTmdb() {
    const tmdbId = document.getElementById('addTmdbId').value;
    if (!tmdbId) return;
    const resultContainer = document.getElementById('addTmdbResultContainer');
    const searchBtn = document.getElementById('addTmdbSearchBtn');
    resultContainer.style.display = 'block';
    resultContainer.innerHTML = 'Buscando...';
    searchBtn.disabled = true;

    try {
        const res = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_API_KEY}&language=es`);
        const data = await res.json();
        currentTmdbData = data;
        const posterUrl = data.poster_path ? `https://image.tmdb.org/t/p/w200${data.poster_path}` : '';
        resultContainer.innerHTML = `<div class="modal-body-info"><img src="${posterUrl}" style="width:80px"><div><strong>${data.title}</strong><br><span>${data.release_date.split('-')[0]}</span></div></div>`;
        document.getElementById('addMovieInputs').style.display = 'block';
        document.getElementById('addMovieBtn').style.display = 'inline-block';
    } finally { searchBtn.disabled = false; }
}

async function commitNewMovie() {
    const video = document.getElementById('addVideoLink').value.trim();
    const repo = document.getElementById('addRepoSelect').value;
    const addAtEnd = document.getElementById('addAtEndCheckbox').checked;
    if (!currentTmdbData || !video || !repo) return;

    if (!await showCustomDialog(`¬øAgregar "${currentTmdbData.title}"?`, true, 'S√≠, Agregar', 'Cancelar')) return;

    try {
        const target = allM3UData.find(r => r.repo === repo);
        const contentUrl = `https://api.github.com/repos/${username}/${repo}/contents/${target.m3uFileName}`;
        const res = await fetch(contentUrl, { headers: { Authorization: `token ${token}` } });
        const data = await res.json();
        let content = decodeURIComponent(escape(atob(data.content))).trim();

        const tmdbId = currentTmdbData.id;
        const year = currentTmdbData.release_date.split('-')[0];
        const logo = `https://image.tmdb.org/t/p/w185${currentTmdbData.poster_path}`;
        const vId = extraerIdDeVideo(video);
        const down = vId ? `https://corterlink.pages.dev/2?id=${vId}` : "";

        // FORMATO REQUERIDO: EXTINF + TVG-LOGO + VIDEO + DOWNLOAD
        const newEntry = `#EXTINF:0,${tmdbId} [LAT] ${currentTmdbData.title} (${year})\ntvg-logo="${logo}"\n${video}${down ? '\n'+down : ''}`;

        if (addAtEnd) {
            content += `\n\n${newEntry}`;
        } else {
            const firstLine = "#EXTM3U";
            content = `${firstLine}\n${newEntry}\n\n${content.substring(firstLine.length).trim()}`;
        }

        const updateRes = await fetch(contentUrl, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: `Add: ${currentTmdbData.title}`, content: btoa(unescape(encodeURIComponent(content + '\n'))), sha: data.sha })
        });

        if (updateRes.ok) location.reload();
    } catch (e) { alert(e); }
}

// ----------------------------------------------------------------------------------
// *** PARSER MEJORADO (DETECTA TVG-LOGO) ***
// ----------------------------------------------------------------------------------
function parseM3U(content) {
  const lines = content.split("\n").map(l => l.trim()).filter(Boolean);
  const items = [];

  for (let i = 0; i < lines.length; i++) {
    if (lines[i].startsWith("#EXTINF")) {
      const extinfLine = lines[i];
      const match = lines[i].match(/#EXTINF:0\s*,\s*(\d+)\s*(.*)/);
      if (!match) continue;

      const tmdbId = match[1];
      const titleRaw = match[2].replace(/\[.*\]/, "").trim();
      const yearMatch = titleRaw.match(/\((\d{4})\)/);
      const title = titleRaw.replace(/\(\d{4}\)/, "").trim();
      const year = yearMatch ? yearMatch[1] : "";

      let tvgLogoLine = "";
      let logoUrl = "";
      let videoLink = "";
      let downloadLink = "";

      let offset = 1;
      // ¬øLa siguiente l√≠nea es tvg-logo?
      if (lines[i + offset] && lines[i + offset].startsWith("tvg-logo=")) {
          tvgLogoLine = lines[i + offset];
          const logoMatch = tvgLogoLine.match(/tvg-logo="([^"]+)"/);
          if (logoMatch) logoUrl = logoMatch[1];
          offset++;
      }

      // Siguiente debe ser Video
      if (lines[i + offset] && !lines[i + offset].startsWith("#")) {
          videoLink = lines[i + offset];
          offset++;
          // Opcional Descarga
          if (lines[i + offset] && !lines[i + offset].startsWith("#")) {
              downloadLink = lines[i + offset];
              i += offset; 
          } else {
              i += (offset - 1);
          }
      }

      items.push({ 
          tmdbId, title, year, videoLink, downloadLink, extinfLine, 
          tvgLogoLine, logo: logoUrl 
      }); 
    }
  }
  return items;
}

// RESTO DE FUNCIONES ORIGINALES
async function cargarTodosLosM3U() {
  const container = document.getElementById("m3uCards");
  container.innerHTML = '<div style="text-align: center; padding: 50px; color: var(--text-muted);">Cargando...</div>';
  try {
    const res = await fetch(`https://api.github.com/users/${username}/repos`, { headers: { Authorization: `token ${token}` } });
    const allRepos = await res.json();
    repositorios = allRepos.filter(repo => repo.name.toUpperCase().startsWith("P"));
    
    const allFetches = repositorios.map(async repo => {
        const resFiles = await fetch(`https://api.github.com/repos/${username}/${repo.name}/contents/`, { headers: { Authorization: `token ${token}` } });
        const files = await resFiles.json();
        for (const file of files) {
            if (file.name.endsWith(".m3u")) {
                const m3uRes = await fetch(file.download_url);
                const text = await m3uRes.text();
                allM3UData.push({ repo: repo.name, content: text, m3uFileName: file.name });
            }
        }
    });
    await Promise.all(allFetches);
    allMovieItems = allM3UData.flatMap(m3u => parseM3U(m3u.content).map(item => ({...item, repo: m3u.repo, m3uFileName: m3u.m3uFileName})));
    allMovieItems.sort((a, b) => (parseInt(b.year) || 0) - (parseInt(a.year) || 0));
    currentFilteredItems = allMovieItems;
    renderPage();
  } catch (e) { container.innerHTML = "Error"; }
}

async function fetchPoster(tmdbId) {
  if (!tmdbId || tmdbId === '0') return null; 
  try {
    const res = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_API_KEY}&language=es`);
    const data = await res.json();
    return data.poster_path ? `https://image.tmdb.org/t/p/w200${data.poster_path}` : null;
  } catch { return null; }
}

async function mostrarCards(itemsToShow) {
  const container = document.getElementById("m3uCards");
  container.innerHTML = ""; 
  if (itemsToShow.length === 0) {
     if (currentFilteredItems.length === 0) container.innerHTML = "No hay resultados";
     return;
  }
  
  for (const item of itemsToShow) {
      const card = document.createElement("div");
      card.className = "card";
      // Prioridad a item.logo (tvg-logo)
      const poster = item.logo || await fetchPoster(item.tmdbId);
      const safeItemBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(item))));

      card.innerHTML = `
        ${poster ? `<img src="${poster}">` : `<div class="card-placeholder">Sin Poster</div>`}
        <div class="card-info">
            <div class="card-details">
              <strong>${item.title}</strong>
              <span>Repo: ${item.repo}</span>
              <span>ID TMDB: ${item.tmdbId} | A√±o: ${item.year || 'N/A'}</span>
            </div>
            <div class="card-actions">
              <button class="delete-button" onclick="eliminarPelicula('${item.title.replace(/'/g, "\\'")}', '${item.repo}', '${item.tmdbId}', '${item.m3uFileName}', '${item.extinfLine.replace(/'/g, "\\'")}', '${item.tvgLogoLine.replace(/'/g, "\\'")}', '${item.videoLink.replace(/'/g, "\\'")}', '${(item.downloadLink||'').replace(/'/g, "\\'")}')">Eliminar</button>
              <button onclick="decodeAndOpenModal('${safeItemBase64}')">Editar</button>
            </div>
        </div>`;
      container.appendChild(card);
  }
}

function decodeAndOpenModal(base64Data) {
    const item = JSON.parse(decodeURIComponent(escape(atob(base64Data))));
    abrirModalEdicion(item);
}

cargarTodosLosM3U();
</script>
</body>
</html>
